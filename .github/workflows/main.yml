name: Samsung Firmware Dumper

on:
  workflow_dispatch:
    inputs:
      firmware_url:
        description: 'Firmware download URL'
        required: true
        type: string

env:
  WORKING_DIR: ./firmware_workspace

jobs:
  samsung-fw-dumper:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # Idea CC: https://github.com/salvogiangri/UN1CA/blob/be58018b3fc4185078d13035d8f3e7b6af417413/.github/workflows/build.yml#L29
    - name: Free disk space (1/3)
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        sudo docker builder prune -a

    - name: Free disk space (2/3)
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true

    - name: Free disk space (3/3)
      uses: rokibhasansagar/slimhub_actions@main
      with:
        retain: 'compiler_cmake'
    # ends: https://github.com/salvogiangri/UN1CA/blob/be58018b3fc4185078d13035d8f3e7b6af417413/.github/workflows/build.yml#L43
    
    - name: Setup environment
      run: |
        mkdir -p ${{ env.WORKING_DIR }}
        cd ${{ env.WORKING_DIR }}
        echo "WORKSPACE=$(pwd)" >> $GITHUB_ENV
    
    - name: Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip tar lz4 android-sdk-libsparse-utils python3-pip python3 bc
        
    # CC: https://github.com/unix3dgforce
    - name: Setup lpunpack
      run: |
        if [ -f "${{ github.workspace }}/lpunpack.py" ]; then
          cp "${{ github.workspace }}/lpunpack.py" "${{ env.WORKSPACE }}/lpunpack.py"
          chmod +x "${{ env.WORKSPACE }}/lpunpack.py"
        else
          curl -L -o "${{ env.WORKSPACE }}/lpunpack.py" "https://raw.githubusercontent.com/unix3dgforce/lpunpack/refs/heads/master/lpunpack.py"
          chmod +x "${{ env.WORKSPACE }}/lpunpack.py"
        fi

    - name: Download firmware
      run: |
        cd ${{ env.WORKSPACE }}
        FILENAME=test.zip
        echo "FILENAME=$FILENAME" >> $GITHUB_ENV        
        wget --save-cookies /dev/null --keep-session-cookies "${{ github.event.inputs.firmware_url }}" -O "$FILENAME"
        FILE_SIZE=$(stat -c%s "$FILENAME")
        FILE_SIZE_GB=$(echo "scale=2; $FILE_SIZE / 1073741824" | bc)
        echo "FILE_SIZE_GB=${FILE_SIZE_GB}" >> $GITHUB_ENV
        
    - name: Extract ZIP if applicable
      run: |
        cd ${{ env.WORKSPACE }}
        unzip -q test.zip -d extracted_zip
        cd extracted_zip
        find . -name "*.tar.md5" | while read tar_file; do
          tar -xf "$tar_file"
        done
        find . -type f \( -name "*.img" -o -name "*.lz4" \) -exec mv {} ../ \;
        cd ..
        
    - name: Process LZ4 files
      run: |
        cd ${{ env.WORKSPACE }}
        if [ -f "super.img.lz4" ]; then
          echo "SUPER_LZ4=true" >> $GITHUB_ENV
          lz4 -d super.img.lz4 super.img
        else
          echo "SUPER_LZ4=false" >> $GITHUB_ENV
        fi
        
    - name: Extract super.img if present
      if: env.SUPER_LZ4 == 'true'
      run: |
        cd ${{ env.WORKSPACE }}
        mkdir -p extracted_super
        python3 lpunpack.py super.img extracted_super/
        
    - name: Upload extracted images to GoFile
      if: env.SUPER_LZ4 == 'true'
      run: |
        cd ${{ env.WORKSPACE }}/extracted_super

        SERVER=$(curl -s https://api.gofile.io/servers | jq -r '.data.servers[0].name')

        for img in *.img; do
            echo "Uploading $img to GoFile..."
            LINK=$(curl -s -F "file=@${img}" "https://${SERVER}.gofile.io/uploadFile" | jq -r '.data.downloadPage')
            echo "$img => $LINK"
            echo "$img: $LINK" >> ${{ env.WORKSPACE }}/gofile_links.txt
        done
    
    - name: GoFile links
      if: env.SUPER_LZ4 == 'true'
      run: |
        echo "=== GoFile Download Links ==="
        cat ${{ env.WORKSPACE }}/gofile_links.txt
    
    - name: Upload GoFile links text file
      if: env.SUPER_LZ4 == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: gofile-links
        path: ${{ env.WORKSPACE }}/gofile_links.txt
        retention-days: 4

    - name: Cleanup workspace
      if: always()
      run: |
        rm -rf ${{ env.WORKSPACE }}

    - name: Summary
      run: |
        echo "Input URL: ${{ github.event.inputs.firmware_url }}"
        echo "Original size: ${{ env.FILE_SIZE_GB }}GB"
        echo "Super.img found: ${{ env.SUPER_LZ4 }}"